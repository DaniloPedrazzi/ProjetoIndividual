<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Individual project for SPTECH Celeste Themed">
    <title>Celeste: Home</title>
    <link rel="shortcut icon" href="./assets/img/celesteLogoOnlyMountain.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/leaderboard.css">
    <script src="js/funcoes.js"></script>
    <script src="header.js"></script>
</head>
<body onload="carregarLeaderboard(), carregarHeader('leaderboard')">
    <div id="header"></div>
    <div class="container">
        <div class="menu">
            <div class="categories">
                <button onclick="changeCategory()" class="category selected">Todas</button>
                <button onclick="changeCategory()" class="category">Any%</button>
                <button onclick="changeCategory()" class="category">All Red Berries</button>
                <button onclick="changeCategory()" class="category">True Ending</button>
                <button onclick="changeCategory()" class="category">All Hearts</button>
                <button onclick="changeCategory()" class="category">100%</button>
                <button onclick="changeCategory()" class="category">Farewell</button>
            </div>
            <div class="addSpeedrun">
                <a href="cadastroSpeedrun.html">+</a>
            </div>
        </div>
        <div id="containerLeaderboard"></div>
        <img src="./assets/img/loading.gif" style="height: 400px; width: 500px; margin-left: 27%;" id="div_aguardar" alt="Gif de carregamento">
    </div>
</body>
</html>

<script>
    var speedruns = [];

    function changeCategory() {
        containerLeaderboard.innerHTML = "";
        aguardar();
        var categories = document.getElementsByClassName("category");
        for (var i = 0; i < categories.length; i++) {
            categories[i].classList.remove("selected");
        }
        event.target.classList.add("selected");
        
        var category = event.target.innerHTML;
        if(category == "Todas"){
            carregarLeaderboard();
            return;
        }else{
            carregarLeaderboardCategoria(category);
        }
    }

    function carregarLeaderboardCategoria(category){
        fetch("/speedruns/listarCategoria", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                categoriaServer: category
            })
        }).then(function (resposta) {
            if (resposta.status == 200) {
                console.log(resposta);

                resposta.json().then(json => {
                    speedruns = json;
                    finalizarAguardar();
                    plotarEntries();
                });
            } else {
                containerLeaderboard.innerHTML = `<div class="entry"><p class="userName">Não há speedruns cadastradas na categoria ${category}</p></div>`;
                console.log("Houve um erro ao tentar trocar a categoria!");
                finalizarAguardar();
            }
        }).catch(function (erro) {
            console.log(erro);
        })
    }

    function carregarLeaderboard() {
        containerLeaderboard.innerHTML = "";
        aguardar();
        fetch("/speedruns/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    speedruns = json;
                    finalizarAguardar();
                    plotarEntries();
                });
            } else {
                finalizarAguardar();
                containerLeaderboard.innerHTML = `<div class="entry"><p class="userName">Houve um erro ao carregar as speedruns!</p></div>`;
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }
        }).catch(function (erro) {
            console.log(erro);
        })
    }

    function plotarEntries(){
        organizarSpeedruns();
        for (let i = 0; i < speedruns.length; i++) {
            containerLeaderboard.innerHTML += `
            <div class="entry" onclick="window.open('${speedruns[i].linkConfirmacao}', '_blank')">
                <div class="left">
                    <p class="position place${i + 1}">${i + 1}</p>
                    <img src="./assets/img/${speedruns[i].pais}.png" alt="" class="flag">
                    <p class="userName">${speedruns[i].username}</p>
                </div>
                <div class="right">
                    <p class="time">${speedruns[i].tempoHora}h ${speedruns[i].tempoMinuto}m ${speedruns[i].tempoSegundo}s ${speedruns[i].tempoMilesimo}ms</p>
                    <p class="date">${calcularData(speedruns[i].dataSpeedrun)}</p>
                    <p class="categoryEntry">${speedruns[i].categoria}</p>
                    <p class="platform">${speedruns[i].plataforma}</p>
                </div>
            </div>`
        }
    }

    function organizarSpeedruns(){
        // Transforma o tempo total em milissegundos
        for (let i = 0; i < speedruns.length; i++) {
            speedruns[i].tempo = speedruns[i].tempoHora * 3600000 + speedruns[i].tempoMinuto * 60000 + speedruns[i].tempoSegundo * 1000 + speedruns[i].tempoMilesimo;
        }
        // Ordena as speedruns por tempo (é um sort() feito na mão)
        for (let i = 0; i < speedruns.length; i++) {
            for (let j = i + 1; j < speedruns.length; j++) {
                if (speedruns[i].tempo > speedruns[j].tempo) {
                    var temp = speedruns[i];
                    speedruns[i] = speedruns[j];
                    speedruns[j] = temp;
                }
            }
        }
    }

    function calcularData(data){
        var currentDate = new Date();
        var dataJS = new Date(data);

        var timeDifference = currentDate - dataJS;
        var seconds = Math.floor(timeDifference / 1000);
        var minutes = Math.floor(seconds / 60);
        var hours = Math.floor(minutes / 60);
        var days = Math.floor(hours / 24);

        if(days > 0){
            return `Há ${days} dias`;
        }else if(hours > 0){
            return `Há ${hours} horas`;
        }else if(minutes > 0){
            return `Há ${minutes} minutos`;
        }else if(seconds > 0){
            return `Há ${seconds} segundos`;
        }else{
            return `Agora`;
        }
    }
</script>