<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Individual project for SPTECH Celeste Themed">
    <title>Celeste: Home</title>
    <link rel="shortcut icon" href="./assets/img/celesteLogoOnlyMountain.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/leaderboard.css">
    <script src="header.js"></script>
</head>
<body onload="carregarLeaderboard(), carregarHeader('leaderboard')">
    <div id="header"></div>
    <div class="container">
        <h1 class="title">Leaderboard</h1>
        <div class="menu">
            <div class="categories">
                <button onclick="changeCategory()" class="category selected">Todas</button>
                <button onclick="changeCategory()" class="category">Any%</button>
                <button onclick="changeCategory()" class="category">All Red Berries</button>
                <button onclick="changeCategory()" class="category">True Ending</button>
                <button onclick="changeCategory()" class="category">All Hearts</button>
                <button onclick="changeCategory()" class="category">100%</button>
                <button onclick="changeCategory()" class="category">Farewell</button>
            </div>
            <div class="addSpeedrun">
                <a href="cadastroSpeedrun.html">+</a>
            </div>
        </div>
        <div id="containerLeaderboard"></div>
    </div>
</body>
</html>

<script>
    var speedruns = [];

    function changeCategory() {
        var categories = document.getElementsByClassName("category");
        for (var i = 0; i < categories.length; i++) {
            categories[i].classList.remove("selected");
        }
        event.target.classList.add("selected");
        
        var category = event.target.innerHTML;
        if(category == "Todas"){
            carregarLeaderboard();
            return;
        }else{
            carregarLeaderboardCategoria(category);
        }
    }

    function carregarLeaderboardCategoria(category){
        fetch("/speedruns/listarCategoria", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                categoriaServer: category
            })
        }).then(function (resposta) {
            if (resposta.status == 200) {
                console.log(resposta);

                resposta.json().then(json => {
                    speedruns = json;
                    containerLeaderboard.innerHTML = "";
                    plotarEntries();
                });
            } else {
                containerLeaderboard.innerHTML = `<div class="entry"><p class="userName">Não há speedruns cadastradas na categoria ${category}</p></div>`;
                console.log("Houve um erro ao tentar trocar a categoria!");
            }
        }).catch(function (erro) {
            console.log(erro);
        })
    }

    function carregarLeaderboard() {
        containerLeaderboard.innerHTML = "";
        fetch("/speedruns/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    speedruns = json;
                    plotarEntries();
                });
            } else {
                console.log("Houve um erro ao tentar buscar os dados das speedruns!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }
        }).catch(function (erro) {
            console.log(erro);
        })
    }

    function plotarEntries(){
        for (let i = 0; i < speedruns.length; i++) {
            containerLeaderboard.innerHTML += `
            <div class="entry" onclick="window.open('${speedruns[i].linkConfirmacao}', '_blank')">
                <div class="left">
                    <p class="position">${i + 1}</p>
                    <img src="./assets/img/${speedruns[i].pais}.png" alt="" class="flag">
                    <p class="userName">${speedruns[i].username}</p>
                </div>
                <div class="right">
                    <p class="time">${speedruns[i].tempo}</p>
                    <p class="date">${speedruns[i].dataSpeedrun}</p>
                    <p class="date">${speedruns[i].categoria}</p>
                    <p class="platform">${speedruns[i].plataforma}</p>
                </div>
            </div>`
        }
    }
</script>